generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Tenant (Multi-tenancy)
model Tenant {
  id              String   @id @default(cuid())
  slug            String   @unique // ex: "locadora-xyz"
  domain          String?  @unique // custom domain opcional
  name            String   // "Locadora XYZ"
  logo            String?
  primaryColor    String   @default("#000000")

  // Dados de contato
  email           String
  phone           String
  address         String?

  // Integrações
  whatsappToken   String?  @db.Text
  whatsappPhone   String?
  googleCalendarId String?
  stripeAccountId String?

  // Dados Fiscais
  cnpj                 String?
  inscricaoEstadual    String?
  inscricaoMunicipal   String?
  regimeTributario     String?   // SIMPLES_NACIONAL, LUCRO_PRESUMIDO, LUCRO_REAL, MEI
  codigoMunicipio      String?   // Código IBGE do município

  // Feature Flags / Módulos
  nfseEnabled          Boolean  @default(false)  // Notas Fiscais (NFS-e)
  stockEnabled         Boolean  @default(true)   // Gestão de Estoque
  financialEnabled     Boolean  @default(true)   // Módulo Financeiro
  reportsEnabled       Boolean  @default(true)   // Relatórios Avançados
  apiEnabled           Boolean  @default(false)  // API de Integração
  webhooksEnabled      Boolean  @default(false)  // Webhooks
  multiUserEnabled     Boolean  @default(true)   // Múltiplos Usuários
  customDomainsEnabled Boolean  @default(false)  // Domínios Personalizados

  active          Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Templates de documentos
  contractTemplate  String?  @db.Text
  receiptTemplate   String?  @db.Text

  users           User[]
  equipments      Equipment[]
  bookings        Booking[]
  customers       Customer[]
  activityLogs    ActivityLog[]
  apiKeys         ApiKey[]
  webhooks        Webhook[]
  equipmentCosts  EquipmentCost[]
  stockMovements  StockMovement[]
  fiscalConfig    TenantFiscalConfig?
  invoices        Invoice[]
}

// Usuário (Admin da locadora)
model User {
  id               String   @id @default(cuid())
  email            String   @unique
  passwordHash     String
  name             String
  role             Role     @default(ADMIN)
  emailVerified    Boolean  @default(false)
  emailVerifiedAt  DateTime?

  tenantId      String
  tenant        Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  activityLogs  ActivityLog[]
  autoLoginTokens AutoLoginToken[]
  stockMovements StockMovement[]
  verificationTokens VerificationToken[]

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

// Token temporário para auto-login após registro
model AutoLoginToken {
  id          String   @id @default(cuid())
  token       String   @unique // Token único e seguro
  used        Boolean  @default(false)
  expiresAt   DateTime // Expira em 30 minutos

  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt   DateTime @default(now())

  @@index([token, used, expiresAt])
}

// Token de verificação (email, reset de senha)
model VerificationToken {
  id          String   @id @default(cuid())
  token       String   @unique
  type        TokenType
  used        Boolean  @default(false)
  expiresAt   DateTime

  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt   DateTime @default(now())

  @@index([token, type, used, expiresAt])
  @@index([userId, type])
}

enum TokenType {
  EMAIL_VERIFICATION
  PASSWORD_RESET
}

enum Role {
  SUPER_ADMIN  // ODuo - acesso total ao sistema
  ADMIN        // Dono da locadora - controle total do tenant
  MANAGER      // Gerente - cria e edita (não deleta)
  OPERATOR     // Operador - cria reservas, vê clientes e equipamentos
  VIEWER       // Visualizador - apenas leitura
}

// Equipamento
model Equipment {
  id            String   @id @default(cuid())
  name          String
  description   String?  @db.Text
  category      String
  images        String[]
  pricePerHour  Float?
  pricePerDay   Float
  quantity      Int      @default(1)  // Campo legado, manter para compatibilidade
  status        EquipmentStatus @default(AVAILABLE)

  // Campos de Gestão de Estoque
  totalStock        Int      @default(1)    // Total de unidades no inventário
  availableStock    Int      @default(1)    // Disponível para reserva
  reservedStock     Int      @default(0)    // Reservado em locações ativas
  maintenanceStock  Int      @default(0)    // Em manutenção
  damagedStock      Int      @default(0)    // Avariado/danificado
  minStockLevel     Int      @default(1)    // Nível mínimo para alerta
  unitCost          Float?                   // Custo unitário médio

  // Dados de aquisição
  purchasePrice Float?
  purchaseDate  DateTime?

  tenantId      String
  tenant        Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  bookings      Booking[]
  bookingItems  BookingItem[]
  unavailableDates UnavailableDate[]
  costs         EquipmentCost[]
  documents     EquipmentDocument[]
  stockMovements StockMovement[]
  rentalPeriods RentalPeriod[]

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([tenantId, status])
  @@index([tenantId, status, category])
  @@index([tenantId, availableStock])
}

// Períodos de locação customizáveis
model RentalPeriod {
  id            String   @id @default(cuid())
  days          Int      // Quantidade de dias do período (ex: 1, 7, 15, 30)
  price         Float    // Valor em reais para esse período
  label         String?  // Label opcional (ex: "Diária", "Semanal", "Quinzenal", "Mensal")

  equipmentId   String
  equipment     Equipment @relation(fields: [equipmentId], references: [id], onDelete: Cascade)

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@unique([equipmentId, days]) // Não pode ter dois períodos com mesma quantidade de dias
  @@index([equipmentId])
}

enum EquipmentStatus {
  AVAILABLE
  RENTED
  MAINTENANCE
  INACTIVE
}

// Bloqueios de data
model UnavailableDate {
  id           String   @id @default(cuid())
  startDate    DateTime
  endDate      DateTime
  reason       String?

  equipmentId  String
  equipment    Equipment @relation(fields: [equipmentId], references: [id], onDelete: Cascade)

  createdAt    DateTime @default(now())
}

// Cliente
model Customer {
  id           String   @id @default(cuid())
  name         String
  email        String?
  phone        String
  cpfCnpj      String?
  address      String?
  city         String?
  state        String?
  zipCode      String?
  notes        String?  @db.Text

  tenantId     String
  tenant       Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  bookings     Booking[]

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([tenantId])
}

// Locação
model Booking {
  id              String   @id @default(cuid())
  bookingNumber   String   @unique @default(cuid())

  startDate       DateTime
  endDate         DateTime
  startTime       String?
  endTime         String?

  totalPrice      Float
  status          BookingStatus @default(PENDING)

  // Campo legado - manter para compatibilidade com reservas existentes
  equipmentId     String?
  equipment       Equipment? @relation(fields: [equipmentId], references: [id])

  customerId      String
  customer        Customer  @relation(fields: [customerId], references: [id])

  tenantId        String
  tenant          Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  paymentIntentId String?
  paidAt          DateTime?

  contractUrl     String?
  notes           String?  @db.Text

  confirmationSent Boolean @default(false)
  reminderSent     Boolean @default(false)

  googleEventId   String?

  // Relações
  documents       BookingDocument[]
  items           BookingItem[]
  stockMovements  StockMovement[]
  invoices        Invoice[]

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([tenantId, status])
  @@index([tenantId, status, startDate])
  @@index([equipmentId, startDate, endDate])
}

enum BookingStatus {
  PENDING
  CONFIRMED
  COMPLETED
  CANCELLED
}

// Registro de Atividades (Auditoria)
model ActivityLog {
  id          String   @id @default(cuid())
  action      String   // "CREATE", "UPDATE", "DELETE", "LOGIN", "LOGOUT"
  entity      String   // "USER", "CUSTOMER", "EQUIPMENT", "BOOKING"
  entityId    String?  // ID do registro afetado
  description String   @db.Text // Descrição detalhada da ação
  metadata    Json?    // Dados adicionais (antes/depois, etc)

  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  createdAt   DateTime @default(now())

  @@index([tenantId, createdAt])
  @@index([userId, createdAt])
  @@index([entity, entityId])
}

// API Keys para integração
model ApiKey {
  id          String   @id @default(cuid())
  name        String   // Nome descritivo: "Integração Mobile App"
  key         String   @unique // A chave API em si (hash)
  prefix      String   // Primeiros caracteres para identificação (ex: "sk_test_abc...")

  permissions Json?    // Permissões específicas da key

  lastUsedAt  DateTime?
  expiresAt   DateTime? // Opcional: data de expiração

  active      Boolean  @default(true)

  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([tenantId, active])
  @@index([key])
}

// Webhooks para notificações
model Webhook {
  id          String   @id @default(cuid())
  name        String   // Nome descritivo
  url         String   // URL do webhook
  events      String[] // ["booking.created", "booking.updated", "equipment.created"]

  secret      String?  // Secret para validar requests

  active      Boolean  @default(true)

  lastTriggeredAt DateTime?
  failureCount    Int @default(0)

  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([tenantId, active])
}

// Custos do Equipamento (manutenção, seguro, combustível, etc)
model EquipmentCost {
  id            String    @id @default(cuid())
  type          CostType
  description   String
  amount        Float
  date          DateTime
  recurring     Boolean   @default(false)

  equipmentId   String
  equipment     Equipment @relation(fields: [equipmentId], references: [id], onDelete: Cascade)

  tenantId      String
  tenant        Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  createdAt     DateTime  @default(now())

  @@index([equipmentId, date])
  @@index([tenantId, type])
}

enum CostType {
  PURCHASE      // Compra inicial
  MAINTENANCE   // Manutenção
  INSURANCE     // Seguro
  FUEL          // Combustível
  REPAIR        // Reparo
  DEPRECIATION  // Depreciação
  OTHER         // Outros
}

// Documentos anexados ao Equipamento (manuais, garantias, etc)
model EquipmentDocument {
  id            String    @id @default(cuid())
  name          String
  type          DocType
  url           String
  fileSize      Int?

  equipmentId   String
  equipment     Equipment @relation(fields: [equipmentId], references: [id], onDelete: Cascade)

  uploadedAt    DateTime  @default(now())

  @@index([equipmentId])
}

enum DocType {
  MANUAL        // Manual do equipamento
  WARRANTY      // Garantia
  CERTIFICATE   // Certificado
  INVOICE       // Nota fiscal de compra
  OTHER         // Outros
}

// Documentos gerados para Reservas (contrato, recibo, nota)
model BookingDocument {
  id            String         @id @default(cuid())
  type          BookingDocType
  url           String
  generatedAt   DateTime       @default(now())
  sentAt        DateTime?
  sentTo        String?

  bookingId     String
  booking       Booking        @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  @@index([bookingId])
}

enum BookingDocType {
  CONTRACT      // Contrato de locação
  RECEIPT       // Recibo
  INVOICE       // Nota fiscal
}

// ============================================
// GESTÃO DE ESTOQUE
// ============================================

// Item de uma Reserva (suporta múltiplos equipamentos por reserva)
model BookingItem {
  id              String    @id @default(cuid())

  bookingId       String
  booking         Booking   @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  equipmentId     String
  equipment       Equipment @relation(fields: [equipmentId], references: [id])

  quantity        Int       @default(1)    // Quantidade reservada
  unitPrice       Float                     // Preço unitário no momento da reserva
  totalPrice      Float                     // quantity * unitPrice * dias

  // Controle de devolução
  deliveredQty    Int       @default(0)    // Quantidade entregue
  returnedQty     Int       @default(0)    // Quantidade devolvida OK
  damagedQty      Int       @default(0)    // Quantidade devolvida com avaria

  notes           String?   @db.Text

  createdAt       DateTime  @default(now())

  @@unique([bookingId, equipmentId])
  @@index([equipmentId])
  @@index([bookingId])
}

// Movimentação de Estoque (histórico/auditoria)
model StockMovement {
  id              String          @id @default(cuid())
  type            MovementType

  quantity        Int             // Quantidade movimentada (sempre positivo)
  previousStock   Int             // Estoque antes da movimentação
  newStock        Int             // Estoque após a movimentação

  reason          String?         @db.Text  // Motivo/observação

  equipmentId     String
  equipment       Equipment       @relation(fields: [equipmentId], references: [id], onDelete: Cascade)

  // Referência opcional à reserva (para movimentos de locação)
  bookingId       String?
  booking         Booking?        @relation(fields: [bookingId], references: [id], onDelete: SetNull)

  // Usuário que realizou a movimentação
  userId          String
  user            User            @relation(fields: [userId], references: [id])

  tenantId        String
  tenant          Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  createdAt       DateTime        @default(now())

  @@index([equipmentId, createdAt])
  @@index([tenantId, createdAt])
  @@index([bookingId])
  @@index([type])
}

enum MovementType {
  PURCHASE        // Compra/Entrada de estoque
  RENTAL_OUT      // Saída para locação
  RENTAL_RETURN   // Retorno de locação
  ADJUSTMENT      // Ajuste manual de inventário
  DAMAGE          // Registro de avaria
  LOSS            // Perda/Extravio
  MAINTENANCE_OUT // Enviado para manutenção
  MAINTENANCE_IN  // Retorno de manutenção
}

// ============================================
// INTEGRAÇÃO FISCAL - NFS-e (Focus NFe)
// ============================================

// Configuração Fiscal do Tenant
model TenantFiscalConfig {
  id                     String   @id @default(cuid())

  tenantId               String   @unique
  tenant                 Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Credenciais Focus NFe (criptografadas)
  focusNfeToken          String?  @db.Text
  focusNfeEnvironment    String   @default("HOMOLOGACAO") // HOMOLOGACAO ou PRODUCAO

  // Configuração NFS-e
  nfseSerie              String   @default("1")
  nfseProximoNumero      Int      @default(1)

  // Padrões do serviço
  codigoServico          String?  // Código LC 116
  aliquotaIss            Float    @default(0)
  issRetido              Boolean  @default(false)

  // Template de descrição do serviço (suporta variáveis)
  descricaoTemplate      String?  @db.Text
  // Variáveis: {bookingNumber}, {startDate}, {endDate}, {totalDays}, {customerName}, {itemsList}, {totalPrice}

  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt

  @@index([tenantId])
}

// NFS-e (Nota Fiscal de Serviço Eletrônica)
model Invoice {
  id                   String   @id @default(cuid())
  internalRef          String   @unique // Referência interna enviada ao Focus NFe

  // Dados da NFS-e (retornados pela prefeitura)
  numero               String?  // Número da NFS-e
  serie                String?
  codigoVerificacao    String?  // Código de verificação da prefeitura

  // Status
  status               String   @default("PENDING") // PENDING, PROCESSING, AUTHORIZED, REJECTED, CANCELLED, ERROR
  focusNfeStatus       String?  // Status retornado pelo Focus NFe

  // URLs dos documentos
  xmlUrl               String?
  pdfUrl               String?

  // Valores (snapshot para auditoria)
  valorServicos        Float
  valorTotal           Float
  aliquotaIss          Float?
  valorIss             Float?
  issRetido            Boolean  @default(false)
  descricaoServico     String   @db.Text
  codigoServico        String?

  // Dados do tomador (snapshot)
  tomadorNome          String
  tomadorCpfCnpj       String?
  tomadorEmail         String?
  tomadorEndereco      Json?    // { logradouro, numero, complemento, bairro, cidade, uf, cep }

  // Relacionamentos
  bookingId            String
  booking              Booking  @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  tenantId             String
  tenant               Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Erros e retry
  errorCode            String?
  errorMessage         String?  @db.Text
  retryCount           Int      @default(0)

  // Cancelamento
  cancelledAt          DateTime?
  cancellationReason   String?  @db.Text

  // Timestamps
  emittedAt            DateTime? // Quando foi autorizada pela prefeitura
  sentToCustomerAt     DateTime? // Quando foi enviada por email ao cliente
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt

  @@index([tenantId, status])
  @@index([bookingId])
  @@index([internalRef])
  @@index([tenantId, createdAt])
}
